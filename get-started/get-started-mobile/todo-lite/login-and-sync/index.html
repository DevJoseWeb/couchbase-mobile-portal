<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html><head><title>Login and Sync | Couchbase - Mobile Developers</title><link rel="stylesheet" type="text/css" href="../../../../styles/style.css"></link><style class="language-stripe" id="language-stripe-objective-c" type="text/css">*.stripe-display.objective-c{display:inline;}*.stripe-active.objective-c{background:rgba(0, 0, 0, 0.05);}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-swift" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:inline;}*.stripe-active.swift{background:rgba(0, 0, 0, 0.05);}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-java" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:inline;}*.stripe-active.java{background:rgba(0, 0, 0, 0.05);}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-android" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:inline;}*.stripe-active.android{background:rgba(0, 0, 0, 0.05);}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-c" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:inline;}*.stripe-active.c{background:rgba(0, 0, 0, 0.05);}</style><script type="text/javascript">var languages = ["objective-c","swift","java","android","c"];
                    
	                var cookies = document.cookie.split(';');
				    for(var i=0; i<cookies.length; i++) {
				        var cookie = cookies[i].trim();
				        
				        if (cookie.indexOf("language=")==0) {
				            var selectedLanguage = cookie.substring(9, cookie.length);
				            if (selectedLanguage.length > 0) {
				                document.write("<style class='language-stripe' type='text/css'>");
				                for (var j=0; j<languages.length; j++) {
				                    var language = languages[j];
				                    document.write("*.stripe-display." + language + "{display:" + (language == selectedLanguage ? "inline" : "none") + ";}");
                                    document.write("*.stripe-active." + language + "{background:" + (language == selectedLanguage ? "rgba(0, 0, 0, 0.05)" : "transparent") + ";}");
				                }
				                document.write("</style>");
				            }
				            break;
				        }
				    }
				    
			    </script><script type="text/javascript">
                var rootPath = "../../../../";</script><script src="../../../../scripts/core.js"></script><script src="../../../../scripts/search-core.js"></script><script src="../../../../scripts/search.js"></script><script src="../../../../scripts/search-index.js"></script><script type="text/javascript">
	        
	        var _gaq = _gaq || [];
	        _gaq.push(['_setAccount', 'UA-7763794-1']);
	        _gaq.push(['_trackPageview']);
	        
	        (function() {
	            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	        })();
	        
	    </script></head><body onload="init()"><div class="page-header"><table class="navigator-bar"><tr><td><a class="dark logo" href="../../../../index.html"><div>Couchbase</div><div>Mobile Developers</div></a></td><td><a class="dark active" href="../../../../get-started/get-started-mobile/index.html">Get Started</a></td><td><a class="dark" href="../../../../develop/training/build-first-ios-app/index.html">Develop</a></td><td><a class="dark" href="https://forums.couchbase.com/mobile">Forums</a></td><td width="100%"></td><td><input class="search" type="text" onkeyup="search_onkeyup(this)" onchange="search_onchange(this)" onfocus="search_onfocus(this)" onblur="search_onblur(this)"></input></td></tr></table><div class="search-results-wrapper"><div class="search-results-floater"><div id="search-results" class="hidden"></div></div></div></div><div class="header-spacer"></div><div class="page-wrapper"><nav><ul class="nav-list"><li class="nav-section expanded"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/index.html">5 Minutes to Awesome</a></div><ul><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/ios/index.html">iOS</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/ios/before-you-begin/index.html">はじめに</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/ios/building-todo-lite/index.html">Todo Liteを実際に作ってみる</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/ios/create-new-project/index.html">Creating a new project</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/android/index.html">Android</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/before-you-begin/index.html">はじめに</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/building-todo-lite/index.html">Todo Liteを実際に作ってみる</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/get-started-eclipse/index.html">Create a new project with Eclipse</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/get-started-studio/index.html">Create a new project with Android Studio</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/net-mobile/index.html">.NET</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/net-mobile/before-you-begin/index.html">はじめに</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/net-mobile/building-todolite-net/index.html">Todo Liteを作ってみる (Coming soon!)</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/net-mobile/create-new-project/index.html">Creating a new project</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/phonegap/index.html">PhoneGap</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/phonegap/prepare/index.html">Prepare your workstation</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/phonegap/build-and-run/index.html">Build and run</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/phonegap/troubleshooting/index.html">Troubleshooting</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/index.html">Sync｜組込みのNoSQLデータベースとサーバを簡単に同期</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/local-first-data/index.html">ローカルファーストのデータ</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/cloud-data/index.html">クラウド上のデータ</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/sync-function-example/index.html">Sync(同期)機能について</a></li></ul></li><li class="nav-subsection expanded"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/todo-lite/index.html">ToDo Lite Code Tour</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/application-launch/index.html">Application Launch</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/create-and-update-tasks/index.html">Create and Update Task Documents</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/attach-a-photo/index.html">Attach a Photo</a></li><li class="nav-item active"><a href="../../../../get-started/get-started-mobile/todo-lite/login-and-sync/index.html">Login and Sync</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/sharing-lists/index.html">Sharing Lists</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/whats-missing/index.html">What's Missing?</a></li></ul></li></ul></li></ul></nav><article class="content-wrapper"><h1>Login and Sync</h1><div class="toc"><h2>In this document</h2><ul class="plain"><li><a href="#trigger-authenticated-sync">Trigger Authenticated Sync</a></li><li><a href="#tag-user-data">Tag User Documents</a></li></ul></div><p>When the user logs in, the application can trigger sync using the credentials 
                         obtained during the login process. In the application, the logic gets a little 
                    hard to follow, as this code is also responsible for prompting a fresh login when sessions
                    expire, etc. So we'll just look at a couple of example snippets. If you cloned the source
                    code yourself as part of a Getting Started tutorial (<a href="../../../../get-started/get-started-mobile/ios/building-todo-lite/index.html#building-todo-lite">iOS</a>, <a href="../../../../get-started/get-started-mobile/phonegap/build-and-run/index.html">PhoneGap</a>, or <a href="../../../../get-started/get-started-mobile/android/building-todo-lite/index.html#building-todo-lite">Android</a>) now 
                    might be a good time to browse it.</p><h2 id="trigger-authenticated-sync">Trigger Authenticated Sync</h2><hr></hr>
                    

                                        <div class="tab-bar"><a href="javascript:setLanguage(&#34;objective-c&#34;)" class="tab stripe-active objective-c">Objective-C</a><a href="javascript:setLanguage(&#34;swift&#34;)" class="tab stripe-active swift disabled">Swift</a><a href="javascript:setLanguage(&#34;java&#34;)" class="tab stripe-active java">Java</a><a href="javascript:setLanguage(&#34;android&#34;)" class="tab stripe-active android">Android</a><a href="javascript:setLanguage(&#34;c&#34;)" class="tab stripe-active c disabled">C#</a></div><span class="stripe-display objective-c"><pre><code>- (void)defineSync {
    pull = [_database createPullReplication:_remoteURL];
    pull.continuous = YES;
    
    push = [_database createPushReplication:_remoteURL];
    push.continuous = YES;
    
    [self listenForReplicationEvents: push];
    [self listenForReplicationEvents: pull];
    
    [_authenticator registerCredentialsWithReplications: @[pull, push]];
}                             
                              
</code></pre></span><span class="stripe-display swift"><pre><code class="disabled">No code example is currently available.</code></pre></span><span class="stripe-display java"><pre><code>public void startReplicationSyncWithCustomCookie(String name, String value, String path, Date expirationDate, boolean secure, boolean httpOnly) {
    Replication[] replications = createReplications();
    Replication pullRep = replications[0];
    Replication pushRep = replications[1];
    pullRep.setCookie(name, value, path, expirationDate, secure, httpOnly);
    pushRep.setCookie(name, value, path, expirationDate, secure, httpOnly);
    pullRep.start();
    pushRep.start();
    Log.v(TAG, "Start Replication Sync ...");
}                            
                          
</code></pre></span><span class="stripe-display android"><pre><code>public void startReplicationSyncWithCustomCookie(String name, String value, String path, Date expirationDate, boolean secure, boolean httpOnly) {
    Replication[] replications = createReplications();
    Replication pullRep = replications[0];
    Replication pushRep = replications[1];
    pullRep.setCookie(name, value, path, expirationDate, secure, httpOnly);
    pushRep.setCookie(name, value, path, expirationDate, secure, httpOnly);
    pullRep.start();
    pushRep.start();
    Log.v(TAG, "Start Replication Sync ...");
}                            
                          
</code></pre></span><span class="stripe-display c"><pre><code class="disabled">No code example is currently available.</code></pre></span>
                         <h2 id="tag-user-data">Tag User Documents</h2><hr></hr>
                                        <p>
                         The user may create lists and tasks without ever establishing a connection to the cloud host. If they 
                         decide they want to sync, they can authenicate (in the example app we use Facebook but you can easily
                         do custom auth). Because the data was created before we had an authenticated user to connect it with, 
                         documents are missing <code>user_id</code> tags, so a crucial step before we actually sync, is to tag 
                         all the existing local data with the <code>user_id</code>. 
                         (In our case we use the email address associated with the Facebook account)
                    </p>
                                                            <div class="tab-bar"><a href="javascript:setLanguage(&#34;objective-c&#34;)" class="tab stripe-active objective-c">Objective-C</a><a href="javascript:setLanguage(&#34;swift&#34;)" class="tab stripe-active swift disabled">Swift</a><a href="javascript:setLanguage(&#34;java&#34;)" class="tab stripe-active java">Java</a><a href="javascript:setLanguage(&#34;android&#34;)" class="tab stripe-active android">Android</a><a href="javascript:setLanguage(&#34;c&#34;)" class="tab stripe-active c disabled">C#</a></div><span class="stripe-display objective-c"><pre><code>+ (void) updateAllListsInDatabase: (CBLDatabase*)database withOwner: (Profile*)owner error: (NSError**)e {
    CBLQueryEnumerator *myLists = [[List queryListsInDatabase:database] run:e];
    if (*e) {
        return;
    }
    for (CBLQueryRow* row in myLists) {
        List* list = [List modelForDocument: row.document];
        list.owner = owner;
        [list save:e];
        if (*e) {
            return;
        }
    }
}                          
                              
</code></pre></span><span class="stripe-display swift"><pre><code class="disabled">No code example is currently available.</code></pre></span><span class="stripe-display java"><pre><code>public static void assignOwnerToListsIfNeeded(Database database, Document user)
        throws CouchbaseLiteException {
    QueryEnumerator enumerator = getQuery(database).run();
    if (enumerator == null)
        return;
    while (enumerator.hasNext()) {
        Document document = enumerator.next().getDocument();
        String owner = (String) document.getProperty("owner");
        if (owner != null) continue;
        Map&lt;String, Object&gt; properties = new HashMap&lt;String, Object&gt;();
        properties.putAll(document.getProperties());
        properties.put("owner", user.getId());
        document.putProperties(properties);
    }
}
                        
                          
</code></pre></span><span class="stripe-display android"><pre><code>public static void assignOwnerToListsIfNeeded(Database database, Document user)
        throws CouchbaseLiteException {
    QueryEnumerator enumerator = getQuery(database).run();
    if (enumerator == null)
        return;
    while (enumerator.hasNext()) {
        Document document = enumerator.next().getDocument();
        String owner = (String) document.getProperty("owner");
        if (owner != null) continue;
        Map&lt;String, Object&gt; properties = new HashMap&lt;String, Object&gt;();
        properties.putAll(document.getProperties());
        properties.put("owner", user.getId());
        document.putProperties(properties);
    }
}
                        
                          
</code></pre></span><span class="stripe-display c"><pre><code class="disabled">No code example is currently available.</code></pre></span>
                    
               </article><div class="page-footer"><span>Copyright © 2014 Couchbase Inc.  All rights reserved.</span><a href="http://www.couchbase.com/terms-of-service">Terms of Use</a><a href="http://www.couchbase.com/privacy">Privacy Policy</a></div></div></body></html>