<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html><head><title>Sync(同期)機能について | Couchbase - Mobile Developers</title><link rel="stylesheet" type="text/css" href="../../../../styles/style.css"></link><style class="language-stripe" id="language-stripe-objective-c" type="text/css">*.stripe-display.objective-c{display:inline;}*.stripe-active.objective-c{background:rgba(0, 0, 0, 0.05);}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-swift" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:inline;}*.stripe-active.swift{background:rgba(0, 0, 0, 0.05);}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-java" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:inline;}*.stripe-active.java{background:rgba(0, 0, 0, 0.05);}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-android" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:inline;}*.stripe-active.android{background:rgba(0, 0, 0, 0.05);}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-c" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:inline;}*.stripe-active.c{background:rgba(0, 0, 0, 0.05);}</style><script type="text/javascript">var languages = ["objective-c","swift","java","android","c"];
                    
	                var cookies = document.cookie.split(';');
				    for(var i=0; i<cookies.length; i++) {
				        var cookie = cookies[i].trim();
				        
				        if (cookie.indexOf("language=")==0) {
				            var selectedLanguage = cookie.substring(9, cookie.length);
				            if (selectedLanguage.length > 0) {
				                document.write("<style class='language-stripe' type='text/css'>");
				                for (var j=0; j<languages.length; j++) {
				                    var language = languages[j];
				                    document.write("*.stripe-display." + language + "{display:" + (language == selectedLanguage ? "inline" : "none") + ";}");
                                    document.write("*.stripe-active." + language + "{background:" + (language == selectedLanguage ? "rgba(0, 0, 0, 0.05)" : "transparent") + ";}");
				                }
				                document.write("</style>");
				            }
				            break;
				        }
				    }
				    
			    </script><script type="text/javascript">
                var rootPath = "../../../../";</script><script src="../../../../scripts/core.js"></script><script src="../../../../scripts/search-core.js"></script><script src="../../../../scripts/search.js"></script><script src="../../../../scripts/search-index.js"></script><script type="text/javascript">
	        
	        var _gaq = _gaq || [];
	        _gaq.push(['_setAccount', 'UA-7763794-1']);
	        _gaq.push(['_trackPageview']);

	        (function() {
	            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	        })();
	        
	    </script></head><body onload="init()"><div class="page-header"><table class="navigator-bar"><tr><td><a class="dark logo" href="../../../../index.html"><div>Couchbase</div><div>Mobile Developers</div></a></td><td><a class="dark active" href="../../../../get-started/get-started-mobile/index.html">Get Started</a></td><td><a class="dark" href="../../../../develop/training/build-first-ios-app/index.html">Develop</a></td><td><a class="dark" href="https://forums.couchbase.com/mobile">Forums</a></td><td width="100%"></td><td><input class="search" type="text" onkeyup="search_onkeyup(this)" onchange="search_onchange(this)" onfocus="search_onfocus(this)" onblur="search_onblur(this)"></input></td></tr></table><div class="search-results-wrapper"><div class="search-results-floater"><div id="search-results" class="hidden"></div></div></div></div><div class="header-spacer"></div><div class="page-wrapper"><nav><ul class="nav-list"><li class="nav-section expanded"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/index.html">5 Minutes to Awesome</a></div><ul><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/ios/index.html">iOS</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/ios/before-you-begin/index.html">はじめに</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/ios/building-todo-lite/index.html">Todo Liteを実際に作ってみる</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/ios/create-new-project/index.html">Creating a new project</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/android/index.html">Android</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/before-you-begin/index.html">はじめに</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/building-todo-lite/index.html">Todo Liteを実際に作ってみる</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/get-started-eclipse/index.html">Create a new project with Eclipse</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/get-started-studio/index.html">Create a new project with Android Studio</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/net-mobile/index.html">.NET</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/net-mobile/before-you-begin/index.html">はじめに</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/net-mobile/building-todolite-net/index.html">Todo Liteを作ってみる (Coming soon!)</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/net-mobile/create-new-project/index.html">Creating a new project</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/phonegap/index.html">PhoneGap</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/phonegap/prepare/index.html">Prepare your workstation</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/phonegap/build-and-run/index.html">ビルドと実行</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/phonegap/troubleshooting/index.html">Troubleshooting</a></li></ul></li><li class="nav-subsection expanded"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/index.html">Sync｜組込みのNoSQLデータベースとサーバを簡単に同期</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/local-first-data/index.html">ローカルファーストのデータ</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/cloud-data/index.html">クラウド上のデータ</a></li><li class="nav-item active"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/sync-function-example/index.html">Sync(同期)機能について</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/todo-lite/index.html">ToDo Liteアプリのコード紹介</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/application-launch/index.html">アプリケーションの開始</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/create-and-update-tasks/index.html">タスクドキュメントの新規作成と更新</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/attach-a-photo/index.html">ファイルの添付</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/login-and-sync/index.html">ログインとSync(同期)</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/sharing-lists/index.html">リストの共有</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/whats-missing/index.html">他に必要な機能は？</a></li></ul></li></ul></li></ul></nav><article class="content-wrapper"><h1>Sync(同期)機能について</h1><div class="toc"><h2>In this document</h2><ul class="plain"><li><a href="#sync-code">JavaScriptのSync(同期)</a></li><li><a href="#function-arguments">Sync(同期)機能の引数</a></li><li><a href="#tasks">タスクのハンドリング</a></li><li><a href="#todo-lists">ToDoアプリ「list」のハンドリング</a></li><li><a href="#todo-lists">ユーザ情報のハンドリング</a></li></ul></div><p>Sync Gatewayではカスタムアプリケーションの動作がJavaScriptで表現され、これによりデータに対してシンプル且つきめ細やかなコントロールを可能とします。この章ではSync Gatewayをどのように動かしてみるかということに触れたいと思いますが、詳細は<a href="../../../../develop/guides/sync-gateway/sync-function-api-guide/intro/index.html#intro">Sync Gatewayの同期機能</a>をご参照ください。</p><h2 id="sync-code">JavaScriptのSync(同期)</h2><hr></hr>
                              <p>ここではToDo LiteアプリのSync(同期)機能を若干簡単にしたものを紹介します。iOS、Android、またPhoneGapに対応します。</p>
                              <pre><code>function(doc, oldDoc) {
     if (doc.type == "task") {
          if (!doc.list_id) {
               throw({forbidden : "Items must have a list_id"})
          }
          requireAccess("list-"+doc.list_id);
          channel("list-"+doc.list_id);
     } else if (doc.type == "list") {
          channel("list-"+doc._id);
          if (!doc.owner) {
               throw({forbidden : "List must have an owner"})
          }
          if (oldDoc) {
               requireUser(oldDoc.owner)
          }
          access(doc.owner, "list-"+doc._id);
          if (Array.isArray(doc.members)) {
               access(doc.members, "list-"+doc._id);
          }
     } else if (doc.type == "profile") {
          channel("profiles");
          var user = doc._id.substring(doc._id.indexOf(":")+1);
          if (user !== doc.user_id) {
               throw({forbidden : "Profile user_id must match docid : " + user + " : " + doc.user_id})
          }
          requireUser(user);
          access(user, "profiles");
     }
}
</code></pre>
                         <h2 id="function-arguments">Sync(同期)機能の引数</h2><hr></hr>
                              <p>それでは、実際にコードをみてRESTのWebアプリケーションサーバが行うロジックを１ページのソースにしましょう。</p>
                              
                              
                              <pre><code>function(doc, oldDoc) {
</code></pre>
                              
                              
                              <p>Sync(同期)機能は、各JSONドキュメントに対して反映されます。これは、1)これから反映しようとしているJSONドキュメント、および2)既にJSONドキュメントが存在している場合の２つの点について考える必要があります。2）の既にドキュメントが存在している場合、変更を行おうとしているユーザがドキュメントのオーナーであることや、アプリケーション側でこのドキュメントの一部に対し変更ができないことを知るのに役立ちます。</p>
                              
                         <h2 id="tasks">タスクのハンドリング</h2><hr></hr>
                              <pre><code>if (doc.type == "task") {
     if (!doc.list_id) {
          throw({forbidden : "Items must have a list_id"})
     }
     requireAccess("list-"+doc.list_id);
     channel("list-"+doc.list_id);                                   
</code></pre>
                              <p>このコードはToDo Liteアプリの中で個別のタスクに対して実行され、ドキュメントに「list_id」フィールドを必要としています。そして、タスクの更新または新規作成したユーザはこのlistへのアクセスを条件とします。検証が無事に終了すれば、このドキュメントはlistが属する「channel」にルーティングされます。このlistにアクセスできる他のユーザが接続した場合、更新されたタスクに同期します。</p>
                         <h2 id="todo-lists">ToDoアプリ「list」のハンドリング</h2><hr></hr>
                              <pre><code>} else if (doc.type == "list") {
  channel("list-"+doc._id);                                  
                            
</code></pre>
                              <p>ここでは、ToDoアプリ「list」に関するmetadataについて考えたいと思います。"channel”を呼び出すと、listのmetadataがlistのchannelと連携します(これはドキュメントのバリデーションが問題なく済んだことが前提となります)。</p>
                              <pre><code>if (!doc.owner) {
  throw({forbidden : "List must have an owner"})
}
if (oldDoc) {
  requireUser(oldDoc.owner)
}                            
                          
</code></pre>
                              <p>listに属するドキュメントは、1）全てのlistは1名のオーナーに属する、そして2）そのオーナーのみ更新できるというシンプルな形で検証されます。(※検証とルーティングの順序はどちらが先になっても問題ありません。ドキュメントのバリ検証がなされなかった場合、同期は反映されません。)</p>

                              <pre><code>access(doc.owner, "list-"+doc._id);
if (Array.isArray(doc.members)) {
  access(doc.members, "list-"+doc._id);
}                          
                          
</code></pre>
                              <p>listのmetadataについて最後に解説するのが、Sync Gatewayで特定のユーザがlistに属するchannelにアクセスできるようにする機能です。最初の<code>access</code>の呼び出しで、listのオーナーはToDoリストからアイテムの読込みができます。次の呼び出しで、配列の中に入っている複数メンバーへのアクセスを許可します。アクセス権の付与によって各メンバーはlistの書込みもできるようになり、これはこの機能の最初のブロックで<code>requireAccess</code>を呼び出したからです。</p>
                         <h2 id="todo-lists">ユーザ情報のハンドリング</h2><hr></hr>
                              <pre><code>} else if (doc.type == "profile") {
  channel("profiles");                            
                            
</code></pre>
                              <p>最後に、ToDo Liteアプリでメンバーのリストが各ユーザに共有され、どのメンバーがどのタスクリストに追加されるかについて紹介します。コードの最初の行はユーザ情報のドキュメントが"profiles”のchannelと連携されます。</p>
                              <pre><code>var user = doc._id.substring(doc._id.indexOf(":")+1);
if (user !== doc.user_id) {
  throw({forbidden : "Profile user_id must match docid : " + user + " : " + doc.user_id})
}
requireUser(user);
                          
</code></pre>
                              <p>ユーザ情報の検証はドキュメントがスキーマの条件を満たすことを保証します(ドキュメントIDはユーザ名の作者と一致する必要があります)。また、あるユーザが他のユーザの情報を変更することを防ぎます。</p>
                              
                              <p>最後に紹介するのは、シンプルには見えますが大きな影響があります。これは"profiles”のchannelにユーザアクセスを付与するものです。これは、仮に新規のユーザがプロファイルを作成した時、"profiles”のchannelを通して、他のユーザプロファイルの読込みのアクセスをこの新規ユーザに付与するようにシステムが動作することを指します。</p>


                              <pre><code>access(user, "profiles");
                      
                          
</code></pre>
                              <p>この章では、Sync(同期)機能の概要を紹介しましたが、もちろんこれが全てではありません。同じような仕組みをREST APIサーバで行おうとすると、どれだけのコードを書かなければいけないかは容易に想像がつくかと思います。また、オフラインで同期した時の懸念点についても考える必要があります。
</p>
                              
                              <p>この章で紹介したSync Gatewayのいくつかの機能(コード)だけでも、従来のソリューションと比較し100倍も効率的にモバイルアプリを開発できるのではないでしょうか？</p>
                         </article><div class="page-footer"><span>Copyright © 2014 Couchbase Inc.  All rights reserved.</span><a href="http://www.couchbase.com/terms-of-service">Terms of Use</a><a href="http://www.couchbase.com/privacy">Privacy Policy</a></div></div></body></html>