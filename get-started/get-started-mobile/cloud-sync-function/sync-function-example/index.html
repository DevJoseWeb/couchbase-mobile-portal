<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html><head><title>Example Sync Function | Couchbase - Mobile Developers</title><link rel="stylesheet" type="text/css" href="../../../../styles/style.css"></link><style class="language-stripe" id="language-stripe-objective-c" type="text/css">*.stripe-display.objective-c{display:inline;}*.stripe-active.objective-c{background:rgba(0, 0, 0, 0.05);}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-swift" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:inline;}*.stripe-active.swift{background:rgba(0, 0, 0, 0.05);}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-java" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:inline;}*.stripe-active.java{background:rgba(0, 0, 0, 0.05);}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-android" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:inline;}*.stripe-active.android{background:rgba(0, 0, 0, 0.05);}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-c" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:inline;}*.stripe-active.c{background:rgba(0, 0, 0, 0.05);}</style><script type="text/javascript">var languages = ["objective-c","swift","java","android","c"];
                    
	                var cookies = document.cookie.split(';');
				    for(var i=0; i<cookies.length; i++) {
				        var cookie = cookies[i].trim();
				        
				        if (cookie.indexOf("language=")==0) {
				            var selectedLanguage = cookie.substring(9, cookie.length);
				            if (selectedLanguage.length > 0) {
				                document.write("<style class='language-stripe' type='text/css'>");
				                for (var j=0; j<languages.length; j++) {
				                    var language = languages[j];
				                    document.write("*.stripe-display." + language + "{display:" + (language == selectedLanguage ? "inline" : "none") + ";}");
                                    document.write("*.stripe-active." + language + "{background:" + (language == selectedLanguage ? "rgba(0, 0, 0, 0.05)" : "transparent") + ";}");
				                }
				                document.write("</style>");
				            }
				            break;
				        }
				    }
				    
			    </script><script type="text/javascript">
                var rootPath = "../../../../";</script><script src="../../../../scripts/core.js"></script><script src="../../../../scripts/search-core.js"></script><script src="../../../../scripts/search.js"></script><script src="../../../../scripts/search-index.js"></script><script type="text/javascript">
	        
	        var _gaq = _gaq || [];
	        _gaq.push(['_setAccount', 'UA-7763794-1']);
	        _gaq.push(['_trackPageview']);
	        
	        (function() {
	            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	        })();
	        
	    </script></head><body onload="init()"><div class="page-header"><table class="navigator-bar"><tr><td><a class="dark logo" href="../../../../index.html"><div>Couchbase</div><div>Mobile Developers</div></a></td><td><a class="dark active" href="../../../../get-started/get-started-mobile/index.html">Get Started</a></td><td><a class="dark" href="../../../../develop/training/build-first-ios-app/index.html">Develop</a></td><td><a class="dark" href="https://forums.couchbase.com/mobile">Forums</a></td><td width="100%"></td><td><input class="search" type="text" onkeyup="search_onkeyup(this)" onchange="search_onchange(this)" onfocus="search_onfocus(this)" onblur="search_onblur(this)"></input></td></tr></table><div class="search-results-wrapper"><div class="search-results-floater"><div id="search-results" class="hidden"></div></div></div></div><div class="header-spacer"></div><div class="page-wrapper"><nav><ul class="nav-list"><li class="nav-section expanded"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/index.html">5 Minutes to Awesome</a></div><ul><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/ios/index.html">iOS</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/ios/before-you-begin/index.html">はじめに</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/ios/building-todo-lite/index.html">Todo Liteを実際に作ってみる</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/ios/create-new-project/index.html">Creating a new project</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/android/index.html">Android</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/before-you-begin/index.html">はじめに</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/building-todo-lite/index.html">Todo Liteを実際に作ってみる</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/get-started-eclipse/index.html">Create a new project with Eclipse</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/android/get-started-studio/index.html">Create a new project with Android Studio</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/net-mobile/index.html">.NET</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/net-mobile/before-you-begin/index.html">はじめに</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/net-mobile/building-todolite-net/index.html">Todo Liteを作ってみる (Coming soon!)</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/net-mobile/create-new-project/index.html">Creating a new project</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/phonegap/index.html">PhoneGap</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/phonegap/prepare/index.html">Prepare your workstation</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/phonegap/build-and-run/index.html">Build and run</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/phonegap/troubleshooting/index.html">Troubleshooting</a></li></ul></li><li class="nav-subsection expanded"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/index.html">Cloud Sync in 100x Less Code</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/local-first-data/index.html">Local First Data</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/cloud-data/index.html">Data in the Cloud</a></li><li class="nav-item active"><a href="../../../../get-started/get-started-mobile/cloud-sync-function/sync-function-example/index.html">Example Sync Function</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../get-started/get-started-mobile/todo-lite/index.html">ToDo Lite Code Tour</a></div><ul><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/application-launch/index.html">Application Launch</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/create-and-update-tasks/index.html">Create and Update Task Documents</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/attach-a-photo/index.html">Attach a Photo</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/login-and-sync/index.html">Login and Sync</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/sharing-lists/index.html">Sharing Lists</a></li><li class="nav-item"><a href="../../../../get-started/get-started-mobile/todo-lite/whats-missing/index.html">What's Missing?</a></li></ul></li></ul></li></ul></nav><article class="content-wrapper"><h1>Example Sync Function</h1><div class="toc"><h2>In this document</h2><ul class="plain"><li><a href="#sync-code">JavaScript Sync Function</a></li><li><a href="#function-arguments">Sync Function Arguments</a></li><li><a href="#tasks">Handling Tasks</a></li><li><a href="#todo-lists">Handling ToDo Lists</a></li><li><a href="#todo-lists">Handling User Profiles</a></li></ul></div><p>In Sync Gateway, custom application behavior is expressed in a JavaScript function which offers simple but fine-grained control over your data. For the details 
                         <a href="../../../../develop/guides/sync-gateway/sync-function-api-guide/intro/index.html#intro">read the sync function documentation</a>, for now I'll just show you one and then describe how it works.</p><h2 id="sync-code">JavaScript Sync Function</h2><hr></hr>
                              <p>Here is a slightly simplified version of the sync function from our example app, ToDo Lite. The same backend supports the iOS, Android, and PhoneGap versions.</p>
                              <pre><code>function(doc, oldDoc) {
     if (doc.type == "task") {
          if (!doc.list_id) {
               throw({forbidden : "Items must have a list_id"})
          }
          requireAccess("list-"+doc.list_id);
          channel("list-"+doc.list_id);
     } else if (doc.type == "list") {
          channel("list-"+doc._id);
          if (!doc.owner) {
               throw({forbidden : "List must have an owner"})
          }
          if (oldDoc) {
               requireUser(oldDoc.owner)
          }
          access(doc.owner, "list-"+doc._id);
          if (Array.isArray(doc.members)) {
               access(doc.members, "list-"+doc._id);
          }
     } else if (doc.type == "profile") {
          channel("profiles");
          var user = doc._id.substring(doc._id.indexOf(":")+1);
          if (user !== doc.user_id) {
               throw({forbidden : "Profile user_id must match docid : " + user + " : " + doc.user_id})
          }
          requireUser(user);
          access(user, "profiles");
     }
}
</code></pre>
                         <h2 id="function-arguments">Sync Function Arguments</h2><hr></hr>
                              <p>Let's go through it one bit at a time and see how we can fit most of what your REST web application server does, into a page of code.</p>
                              
                              
                              <pre><code>function(doc, oldDoc) {
</code></pre>
                              
                              
                              <p>The sync function is run on each mutation independently, and takes two arguments: 
                                   the proposed version of the document, and the previous version of the document, if one exists. 
                                   The old version is useful for validating things like that the person making the change is 
                                   the person who owns this document, or perhaps your application enforces that certain fields 
                                   on the document are immutable.</p>
                              
                         <h2 id="tasks">Handling Tasks</h2><hr></hr>
                              <pre><code>if (doc.type == "task") {
     if (!doc.list_id) {
          throw({forbidden : "Items must have a list_id"})
     }
     requireAccess("list-"+doc.list_id);
     channel("list-"+doc.list_id);                                   
</code></pre>
                              <p>This block runs if the document represents an individual task in ToDo Lite. It requires 
                                   that the document have a list_id field, and that the user who is updating or creating the task 
                                   has access to that list. If the validation passes, the document is routed to a channel for that list. 
                                   The next time anyone who has access to the list connects, they'll sync the updated task.</p>
                         <h2 id="todo-lists">Handling ToDo Lists</h2><hr></hr>
                              <pre><code>} else if (doc.type == "list") {
  channel("list-"+doc._id);                                  
                            
</code></pre>
                              <p>This section is concerned with the metadata associated with a list. The call to "channel" 
                                   will route the list metadata to the channel associated with the list (assuming the validations for this document pass).</p>
                              <pre><code>if (!doc.owner) {
  throw({forbidden : "List must have an owner"})
}
if (oldDoc) {
  requireUser(oldDoc.owner)
}                            
                          
</code></pre>
                              <p>The validations for list documents are simple: all lists must have an owner, 
                                   and lists may only be updated by their owner. (Note that we can express the validations 
                                   and routing in any order -- if the validation fails then any other calls from this invocation
                                   of the sync function will have no effect.)</p>

                              <pre><code>access(doc.owner, "list-"+doc._id);
if (Array.isArray(doc.members)) {
  access(doc.members, "list-"+doc._id);
}                          
                          
</code></pre>
                              <p>The last thing we want to do for the list metadata document, is use it to grant access 
                                   so the right people can read from the list's channel. The first call to <code>access</code> makes sure that
                                   the list owner can sync items from this todo list. The second call is passed an array of members, 
                                   granting each of them access to the list. These access grants will also impact who can write tasks 
                                   to the list, because of the call to <code>requireAccess</code> we made in the first block of this function.
</p>
                         <h2 id="todo-lists">Handling User Profiles</h2><hr></hr>
                              <pre><code>} else if (doc.type == "profile") {
  channel("profiles");                            
                            
</code></pre>
                              <p>The final block of the ToDo Lite sync function is responsible for making sure that the list of 
                                   application users is available to each user, so that users may select each other as members of lists.
                                   The first line of code in this block routes user profile documents to the "profiles" channel.</p>
                              <pre><code>var user = doc._id.substring(doc._id.indexOf(":")+1);
if (user !== doc.user_id) {
  throw({forbidden : "Profile user_id must match docid : " + user + " : " + doc.user_id})
}
requireUser(user);
                          
</code></pre>
                              <p>The validation for profiles ensures that the document meets a schema requirement 
                                   (the document ID must match the username of it's creator). It also prevents anyone from
                                   editing anyone else's profile.</p>
                              
                              <p>The final line of code might be deceptively simple. It grants the user access to the 
                                   "profiles" channel. What this means is that when a new user creates their own profile, the 
                                   system reacts by giving them read access to everyone else's profile via the "profiles" channel.</p>


                              <pre><code>access(user, "profiles");
                      
                          
</code></pre>
                              <p>This tour of an example sync function shows most (but not all) of the tools it offers. 
                                   You can imagine how much code it would take to write a REST API server that enforces similar 
                                   rules. Lots more. And solving the offine sync problem would still be on your todo list.</p>
                              
                              <p>So, will you be 100 times more productive with Couchbase Mobile?</p>
                         </article><div class="page-footer"><span>Copyright © 2014 Couchbase Inc.  All rights reserved.</span><a href="http://www.couchbase.com/terms-of-service">Terms of Use</a><a href="http://www.couchbase.com/privacy">Privacy Policy</a></div></div></body></html>