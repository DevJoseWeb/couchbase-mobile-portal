<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html><head><title>Working with Views | Couchbase Mobile - Developers</title><link rel="stylesheet" type="text/css" href="../../../../styles/style.css"></link><style class="language-stripe" id="language-stripe-objective-c" type="text/css">*.stripe-display.objective-c{display:inline;}*.stripe-active.objective-c{background:rgba(0, 0, 0, 0.05);}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-swift" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:inline;}*.stripe-active.swift{background:rgba(0, 0, 0, 0.05);}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-java" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:inline;}*.stripe-active.java{background:rgba(0, 0, 0, 0.05);}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-android" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:inline;}*.stripe-active.android{background:rgba(0, 0, 0, 0.05);}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-c" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:inline;}*.stripe-active.c{background:rgba(0, 0, 0, 0.05);}</style><script type="text/javascript">var languages = ["objective-c","swift","java","android","c"];
                    
	                var cookies = document.cookie.split(';');
				    for(var i=0; i<cookies.length; i++) {
				        var cookie = cookies[i].trim();
				        
				        if (cookie.indexOf("language=")==0) {
				            var selectedLanguage = cookie.substring(9, cookie.length);
				            if (selectedLanguage.length > 0) {
				                document.write("<style class='language-stripe' type='text/css'>");
				                for (var j=0; j<languages.length; j++) {
				                    var language = languages[j];
				                    document.write("*.stripe-display." + language + "{display:" + (language == selectedLanguage ? "inline" : "none") + ";}");
                                    document.write("*.stripe-active." + language + "{background:" + (language == selectedLanguage ? "rgba(0, 0, 0, 0.05)" : "transparent") + ";}");
				                }
				                document.write("</style>");
				            }
				            break;
				        }
				    }
				    
			    </script><script type="text/javascript">
                var rootPath = "../../../../";</script><script src="../../../../scripts/core.js"></script><script src="../../../../scripts/search-core.js"></script><script src="../../../../scripts/search.js"></script><script src="../../../../scripts/search-index.js"></script><noscript>
            <iframe src="//www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe>
        </noscript><script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer','GTM-MVPNN2');
        </script><script type="text/javascript">
            document.write(unescape("%3Cscript src='//munchkin.marketo.net/munchkin.js' type='text/javascript'%3E%3C/script%3E"));
        </script><script>Munchkin.init('302-GJY-034');</script></head><body onload="init()"><div class="page-header"><table class="navigator-bar"><tr><td><a class="dark logo" href="../../../../index.html"><div>Couchbase Mobile</div><div>Developers</div></a></td><td><a class="dark" href="../../../../get-started/couchbase-mobile-overview/index.html">Get Started</a></td><td><a class="dark active" href="../../../../develop/training/build-first-ios-app/index.html">Develop</a></td><td><a class="dark" href="https://forums.couchbase.com/mobile">Forums</a></td><td width="100%"></td><td><input class="search" type="text" onkeyup="search_onkeyup(this)" onchange="search_onchange(this)" onfocus="search_onfocus(this)" onblur="search_onblur(this)"></input></td></tr></table><div class="search-results-wrapper"><div class="search-results-floater"><div id="search-results" class="hidden"></div></div></div><div class="secondary-navigator-bar"><table class="items"><tr><td><a class="dark active" href="../../../../develop/training/build-first-ios-app/index.html">Training</a></td><td><a class="dark" href="../../../../develop/guides/modeling/index.html">Guides</a></td><td><a class="dark" href="../../../../develop/references/couchbase-lite/index.html">API References</a></td><td><a class="dark" href="../../../../develop/samples/samples/index.html">Samples</a></td><td><a class="dark" href="http://www.couchbase.com/nosql-databases/downloads#Couchbase_Mobile">Downloads</a></td><td width="100%"></td></tr></table></div></div><div class="header-spacer"></div><div class="page-wrapper"><nav><ul class="nav-list"><li class="nav-section expanded"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../develop/training/build-first-ios-app/index.html">Building your first Couchbase Lite iOS app</a></div><ul><li class="nav-item"><a href="../../../../develop/training/build-first-ios-app/create-new-project/index.html">Creating a new project</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-ios-app/create-manager-db/index.html">Creating the manager and a database</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-ios-app/do-crud/index.html">Performing CRUD operations</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-ios-app/add-sync-gateway.xml/index.html">Add Sync Gateway</a></li><li class="nav-item active"><a href="../../../../develop/training/build-first-ios-app/couchbase-lite-views/index.html">Working with Views</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-ios-app/understanding-live-query/index.html">Understanding LiveQuery</a></li></ul></li><li class="nav-section"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../develop/training/build-first-android-app/index.html">Building your first Couchbase Lite Android app</a></div><ul><li class="nav-item"><a href="../../../../develop/training/build-first-android-app/get-started-studio/index.html">Create a new project with Android Studio</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-android-app/starter-code-android/index.html">Creating the manager and a database</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-android-app/do-crud/index.html">Performing CRUD operations</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-android-app/add-sync-gateway.xml/index.html">Add Sync Gateway</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-android-app/couchbase-lite-views/index.html">Working with Views</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-android-app/understanding-live-query/index.html">Understanding LiveQuery</a></li></ul></li><li class="nav-section"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../develop/training/build-first-xamarin-android-app/index.html">Building your first Couchbase Lite Xamarin.Android app</a></div><ul><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-android-app/get-started-xamarin-xs/index.html">Create a new Xamarin.Android project using Xamarin Studio</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-android-app/get-started-xamarin-vs/index.html">Create a new Xamarin.Android project using Visual Studio</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-android-app/starter-code-xamarin-android/index.html">Creating the manager and a database</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-android-app/do-crud/index.html">Performing CRUD operations</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-android-app/add-sync-gateway.xml/index.html">Add Sync Gateway</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-android-app/couchbase-lite-views/index.html">Working with Views</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-android-app/understanding-live-query/index.html">Understanding LiveQuery</a></li></ul></li><li class="nav-section"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../develop/training/build-first-xamarin-ios-app/index.html">Building your first Couchbase Lite Xamarin.iOS app</a></div><ul><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-ios-app/get-started-xamarin-xs/index.html">Create a new Xamarin.iOS project using Xamarin Studio</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-ios-app/get-started-xamarin-vs/index.html">Create a new Xamarin.iOS project using Visual Studio</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-ios-app/starter-code-xamarin-ios/index.html">Creating the manager and a database</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-ios-app/do-crud/index.html">Performing CRUD operations</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-ios-app/add-sync-gateway.xml/index.html">Add Sync Gateway</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-ios-app/couchbase-lite-views/index.html">Working with Views</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-xamarin-ios-app/understanding-live-query/index.html">Understanding LiveQuery</a></li></ul></li><li class="nav-section"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../develop/training/build-first-dotnet-app/index.html">Building your first Couchbase Lite with .NET and WPF</a></div><ul><li class="nav-item"><a href="../../../../develop/training/build-first-dotnet-app/create-new-project/index.html">Creating a new project</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-dotnet-app/create-database/index.html">Creating the manager and a database</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-dotnet-app/crud/index.html">Performing CRUD operations</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-dotnet-app/get-started-vs/index.html">Create a new WPF project using Visual Studio</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-dotnet-app/starter-code-wpf/index.html">Creating the manager and a database</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-dotnet-app/do-crud/index.html">Performing CRUD operations</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-dotnet-app/add-sync-gateway.xml/index.html">Add Sync Gateway</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-dotnet-app/couchbase-lite-views/index.html">Working with Views</a></li><li class="nav-item"><a href="../../../../develop/training/build-first-dotnet-app/understanding-live-query/index.html">Understanding LiveQuery</a></li></ul></li></ul></nav><article class="content-wrapper"><div class="toc"><div class="lesson-nav"><a class="first" href="../../../../develop/training/build-first-ios-app/add-sync-gateway.xml/index.html">〈 Previous</a><a href="../../../../develop/training/build-first-ios-app/understanding-live-query/index.html">Next 〉</a></div><h2>This lesson teaches you to</h2><ol><li><a href="#intro">
                Introduction
            </a></li><li><a href="#creating-view">
                Creating a view
            </a></li><li><a href="#running-query">Running a Query</a></li></ol></div><h1>Working with Views</h1><p>
            Couchbase Lite has a concept called a View, which is
            similar to Views in Couchbase Server.  Views allows
            applications to create and maintain secondary indexes
            which are updated on demand and even have the ability to
            speed aggregation type searches by efficiently storing
            summaries.  In this lesson, we will learn how to create
            and query views.
        </p><h2 id="intro">
                Introduction
            </h2><hr></hr>
                <p>
                    Creating a View in Couchbase Lite is not maintained as a View in the Couchbase Server.  In Couchbase Lite, the View only exists on the mobile device.  We will use a <code>com.couchbase.lite.View</code> for our work here.
                </p>
                <p>
                    There is a factory method on the <code>CBLDatabase</code> called <code>viewNamed</code> for
                    creating this object. We must provide the database a unique name for each view. Let us encapsulate this work now for our application development:
                </p>

                <pre><code>- (CBLView *)getView {
    CBObjects *objects = [CBObjects sharedInstance];
    return [objects.database viewName:kOrderedByDateView];
}
</code></pre>

                <p>
                    We simply pass the parameter name to the factory method and return the freshly created
                    <code>CBLView</code>.
                </p>
            <h2 id="creating-view">
                Creating a view
            </h2><hr></hr>

                <p>
                    Now that we have this method, we can write a specialized method-per-View for each <code>CBLView</code>
                    we wish to create. For example if we want to create a specialized view for eventsByDate we could
                    write this method:
                </p>

                <pre><code>-(void) createOrderedByDateView {&#8232;
    CBObjects *objects = [CBObjects sharedInstance];&#8232;&#8232;
    CBLView *orderedByDateView = [objects.database viewNamed:&#8232;kOrderedByDateView];&#8232;&#8232;
    [orderedByDateView setMapBlock: MAPBLOCK({&#8232;
        emit(doc[kDateField], nil);&#8232;
    }) version: @"1" /* Version of the mapper */ ];&#8232;&#8232;
    NSLog(@"Ordered By Date View created.");&#8232;
}
</code></pre>

                <p>
                    In the method above, first we leverage our private <code>getView</code> method we just wrote
                    to fetch a fresh <code>CBLView</code> from the <code>CBLDatabase</code> with the name
                    eventsByDate.
                </p>

                <p>
                    Next we have to set the map function on the view, using the <code>MAPBLOCK</code> directive:
                </p>

                <ol><li>
                        We do this dynamically with a new Mapper block
                    </li><li>
                        We also provide a version number "1" of the map code for reference 
                    </li></ol>

                <p>
                    The map method provides the references to the document we wish to index and the emitter 
                    will emit that data to the index. We are only interested in the date of the event at this point, so we
                    emit that date and null.
                </p>

            <h2 id="running-query">Running a Query</h2><hr></hr>
                <p>
                    Lastly we test our work in the <code>outputOrderedByDate</code> method. Let us take a look at that
                    code now:
                </p>

                <pre><code>-(void) outputOrderedByDate {
    OrderedByDateView *orderedByDateView = [[OrderedByDateView alloc]&#8232; init];&#8232;
    CBLQuery *orderedByDateQuery = [[orderedByDateView getView]&#8232; createQuery];&#8232;&#8232;
    orderedByDateQuery.descending = YES;
    orderedByDateQuery.startKey = @"2015";&#8232;
    orderedByDateQuery.endKey = @"2014";&#8232;
    orderedByDateQuery.limit = 20;&#8232;
    NSError *error;&#8232;&#8232;
    CBLQueryEnumerator *result = [orderedByDateQuery run: &amp;error];&#8232;&#8232;
    if (!error) {&#8232;
        for (CBLQueryRow * row in result) {&#8232;
            Event *event = [repository get: row.documentID];
            NSLog(@"Found party:%@", event.description);&#8232;
        }&#8232;
    } else {&#8232;
        NSLog(@"Error querying view %@", error.localizedDescription);&#8232;
    }
&#8232;}
</code></pre>

                <p>
                    Let us take a closer look now at this method to print the results of our CBLQuery to the log:
                </p>

                <ol><li>
                        First we need a CBLQuery object which we can get from the CBLView's factory method.
                        See documentation <a href="../../../../develop/guides/couchbase-lite/native-api/query/index.html">
                        here</a>.
                    </li><li>
                        We want the most-future events first and the oldest most-past events last, so we modify the
                        <code>descending</code> property.
                    </li><li>
                        We do not intend to look further in the future than 2015 and do not intend to look into past events prior
                        to 2014, so we set <code>startKey</code> and <code>endKey</code> properties.
                    </li><li>
                        We only want the first 20 results, so we set the limit to 20, which is the maximum number of
                        documents to return.
                    </li><li>
                        After a <code>CBLQuery</code> object is set up properly, you call its run method to get the
                        results. The results are return as a <code>CBLQueryRow</code> object, which mainly serves as
                        an enumerable collection of <code>CBLQueryRow</code> objects.
                    </li><li>
                        We then iterate over the results getting each <code>CBLQueryRow</code>.
                    </li><li>
                        For each <code>CBLQueryRow</code> in the results, we find the <code>documentID</code> and use an
                        <code>EventRepository</code> to fetch the actual complete <code>Event</code> object.
                    </li></ol>

                <pre><code>public void createEventsByDateView() {
    View eventsByDateView = this.getView("eventsByDate");
        eventsByDateView.setMap(
            new Mapper(){
                @Override
                public void map(Map&lt;String, Object&gt; document,
                Emitter emitter) {
                    /* Emit data to matieralized view */
                    emitter.emit(
                        (String) document.get("date"), null);
                }
            }, "1" /* The version number of the mapper... */
        );
    /* end setMap(…) invocation whew! */
    /* Test it out... */
    printQueryToLog(eventsByDateView);
}
</code></pre>

                <p>
                    Within the <code>eventsByDateView</code> method above, we first leverage our private <code>getView(…)</code> method that we just wrote before to fetch a fresh View from the Database with name 'eventsByDate' passed in.
                </p>
                <p>
                    Now we have to set the map function on the view, using <code>setMap(…)</code> and we do this dynamically with a new Mapper object passed in anonymously on the fly.  This works because of the @Override of the <code>map(…)</code> method, where all the action is.
                </p>
                <p>
                    The map method provides the references to the document we wish to index and the emitter will emit that data to the index.  We are only interested in the Event date at this point, so we emit that date and null while providing a version number "1" of the map code.  Lastly we test out the code by executing <code>printQueryToLog()</code>, passing the'eventsByDateView' variable.
                </p>
            </article></div><div class="page-footer"><span>Copyright © 2015 Couchbase Inc.  All rights reserved.</span><a href="http://www.couchbase.com/terms-of-service">Terms of Use</a><a href="http://www.couchbase.com/privacy">Privacy Policy</a></div></body></html>