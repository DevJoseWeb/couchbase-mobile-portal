<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html><head><title>Validation and Authorization | Couchbase - Mobile Developers</title><link rel="stylesheet" type="text/css" href="../../../../../styles/style.css"></link><style class="language-stripe" id="language-stripe-objective-c" type="text/css">*.stripe-display.objective-c{display:inline;}*.stripe-active.objective-c{background:rgba(0, 0, 0, 0.05);}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-swift" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:inline;}*.stripe-active.swift{background:rgba(0, 0, 0, 0.05);}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-java" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:inline;}*.stripe-active.java{background:rgba(0, 0, 0, 0.05);}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-android" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:inline;}*.stripe-active.android{background:rgba(0, 0, 0, 0.05);}*.stripe-display.c{display:none;}*.stripe-active.c{background:transparent;}</style><style class="language-stripe" id="language-stripe-c" type="text/css">*.stripe-display.objective-c{display:none;}*.stripe-active.objective-c{background:transparent;}*.stripe-display.swift{display:none;}*.stripe-active.swift{background:transparent;}*.stripe-display.java{display:none;}*.stripe-active.java{background:transparent;}*.stripe-display.android{display:none;}*.stripe-active.android{background:transparent;}*.stripe-display.c{display:inline;}*.stripe-active.c{background:rgba(0, 0, 0, 0.05);}</style><script type="text/javascript">var languages = ["objective-c","swift","java","android","c"];
                    
	                var cookies = document.cookie.split(';');
				    for(var i=0; i<cookies.length; i++) {
				        var cookie = cookies[i].trim();
				        
				        if (cookie.indexOf("language=")==0) {
				            var selectedLanguage = cookie.substring(9, cookie.length);
				            if (selectedLanguage.length > 0) {
				                document.write("<style class='language-stripe' type='text/css'>");
				                for (var j=0; j<languages.length; j++) {
				                    var language = languages[j];
				                    document.write("*.stripe-display." + language + "{display:" + (language == selectedLanguage ? "inline" : "none") + ";}");
                                    document.write("*.stripe-active." + language + "{background:" + (language == selectedLanguage ? "rgba(0, 0, 0, 0.05)" : "transparent") + ";}");
				                }
				                document.write("</style>");
				            }
				            break;
				        }
				    }
				    
			    </script><script type="text/javascript">
                var rootPath = "../../../../../";</script><script src="../../../../../scripts/core.js"></script><script src="../../../../../scripts/search-core.js"></script><script src="../../../../../scripts/search.js"></script><script src="../../../../../scripts/search-index.js"></script><script type="text/javascript">
	        
	        var _gaq = _gaq || [];
	        _gaq.push(['_setAccount', 'UA-7763794-1']);
	        _gaq.push(['_trackPageview']);
	        
	        (function() {
	            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	        })();
	        
	    </script></head><body onload="init()"><div class="page-header"><table class="navigator-bar"><tr><td><a class="dark logo" href="../../../../../index.html"><div>Couchbase</div><div>Mobile Developers</div></a></td><td><a class="dark" href="../../../../../get-started/get-started-mobile/index.html">Get Started</a></td><td><a class="dark active" href="../../../../../develop/training/build-first-ios-app/index.html">Develop</a></td><td><a class="dark" href="https://forums.couchbase.com/mobile">Forums</a></td><td width="100%"></td><td><input class="search" type="text" onkeyup="search_onkeyup(this)" onchange="search_onchange(this)" onfocus="search_onfocus(this)" onblur="search_onblur(this)"></input></td></tr></table><div class="search-results-wrapper"><div class="search-results-floater"><div id="search-results" class="hidden"></div></div></div><table class="navigator-bar secondary"><tr><td><a class="dark" href="../../../../../develop/training/build-first-ios-app/index.html">Training</a></td><td><a class="dark active" href="../../../../../develop/guides/modeling/index.html">Guides</a></td><td><a class="dark" href="../../../../../develop/references/couchbase-lite/index.html">API References</a></td><td><a class="dark" href="../../../../../develop/samples/samples/index.html">Samples</a></td><td><a class="dark" href="http://www.couchbase.com/nosql-databases/downloads#Couchbase_Mobile">Downloads</a></td><td width="100%"></td></tr></table></div><div class="header-spacer"></div><div class="page-wrapper"><nav><ul class="nav-list"><li class="nav-section"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/modeling/index.html">Data Modeling</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/modeling/basics/index.html">The Basics</a></li><li class="nav-item"><a href="../../../../../develop/guides/modeling/one-to-many/index.html">One-to-Many Relationships</a></li></ul></li><li class="nav-section"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/couchbase-lite/index.html">Couchbase Lite</a></div><ul><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/couchbase-lite/native-api/index.html">Native API</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/couchbase-lite/native-api/manager/index.html">Manager</a></li><li class="nav-item"><a href="../../../../../develop/guides/couchbase-lite/native-api/database/index.html">Database</a></li><li class="nav-item"><a href="../../../../../develop/guides/couchbase-lite/native-api/document/index.html">Document</a></li><li class="nav-item"><a href="../../../../../develop/guides/couchbase-lite/native-api/revision/index.html">Revision</a></li><li class="nav-item"><a href="../../../../../develop/guides/couchbase-lite/native-api/attachment/index.html">Attachment</a></li><li class="nav-item"><a href="../../../../../develop/guides/couchbase-lite/native-api/view/index.html">View</a></li><li class="nav-item"><a href="../../../../../develop/guides/couchbase-lite/native-api/query/index.html">Query</a></li><li class="nav-item"><a href="../../../../../develop/guides/couchbase-lite/native-api/replication/index.html">Replication</a></li><li class="nav-item"><a href="../../../../../develop/guides/couchbase-lite/native-api/model/index.html">Model (iOS only)</a></li></ul></li></ul></li><li class="nav-section expanded"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/sync-gateway/index.html">Sync Gateway</a></div><ul><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/sync-gateway/getting-started-with-sync-gateway/index.html">Running the Sync Gateway</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/getting-started-with-sync-gateway/installing-sync-gateway/index.html">Installing Sync Gateway</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/getting-started-with-sync-gateway/connecting-sync-gateway-to-couchbase-server/index.html">Connecting Sync Gateway to Couchbase Server</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/getting-started-with-sync-gateway/starting-sync-gateway/index.html">Starting Sync Gateway</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/getting-started-with-sync-gateway/stopping-sync-gateway/index.html">Stopping Sync Gateway</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/sync-gateway/administering-sync-gateway/index.html">Configuration and administration</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/administering-sync-gateway/command-line-tool/index.html">Configuration options</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/administering-sync-gateway/administering-the-rest-apis/index.html">Administering the REST APIs</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/administering-sync-gateway/authorizing-users/index.html">Authorizing Users</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/administering-sync-gateway/authenticating-users/index.html">Authenticating Users</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/sync-gateway/channels/index.html">Data routing with "channels"</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/channels/intro/index.html">Introduction to channels</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/channels/developing/index.html">Developing channels</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/channels/troubleshooting/index.html">Troubleshooting channels</a></li></ul></li><li class="nav-subsection expanded"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/sync-gateway/sync-function-api-guide/index.html">Sync Function API</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/sync-function-api-guide/intro/index.html">Introduction</a></li><li class="nav-item active"><a href="../../../../../develop/guides/sync-gateway/sync-function-api-guide/validation/index.html">Validation and Authorization</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/sync-function-api-guide/routing/index.html">Routing</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/sync-gateway/wcbs/index.html">Working with web apps</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/wcbs/bucket-shadowing/index.html">Pre-existing data and "bucket shadowing"</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/sync-gateway/changes-worker/index.html">Connecting additional backend processes</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/changes-worker/pattern/index.html">Changes Worker Pattern</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/changes-worker/example-workflow/index.html">Example Document Workflow</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/changes-worker/push/index.html">Push Notification Code</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/sync-gateway/deployment/index.html">Deployment considerations</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/deployment/during-development/index.html">During Development</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/deployment/in-production/index.html">In Production</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/deployment/troubleshooting/index.html">Troubleshooting and Fine-Tuning</a></li></ul></li><li class="nav-subsection"><div onclick="toggleExpanded(this.parentNode)" class="header"><a href="../../../../../develop/guides/sync-gateway/nginx/index.html">Deploying Sync Gateway behind a reverse proxy</a></div><ul><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/nginx/introduction-to-reverse-proxies/index.html">Introduction to reverse proxies</a></li><li class="nav-item"><a href="../../../../../develop/guides/sync-gateway/nginx/configuring-nginx-for-sync-gateway/index.html">Deploying and configuring nginx</a></li></ul></li></ul></li></ul></nav><article class="content-wrapper"><h1>Validation and Authorization</h1><div class="toc"><h2>In this document</h2><ul class="plain"><li><a href="#throw"> throw ()</a></li><li><a href="#require-user">requireUser (username)</a></li><li><a href="#require-role">requireRole (rolename)</a></li><li><a href="#require-access">requireAccess (channels)</a></li><li><a href="#example">Example</a></li></ul></div><p>The sync function API provides several methods that you can use to
                validate document creation, updates and deletions. For error conditions, you can simply call
                the built-in JavaScript <code>throw()</code> function. You can also enforce user
                access privileges by calling <code>requireUser()</code>,
                <code>requireRole()</code>, or <code>requireAccess()</code>.</p><p>What happens to rejected documents? Firstly, they aren't saved to the
                Sync Gateway's database, so no access changes take effect. Instead an error code
                (usually 403 Forbidden) is returned to the client's replicator. But the client
                still has the invalid document in its local database, and it's up to it to fix it.
                Instead, we recommend that clients not create invalid documents in the first place.
                As much as possible, the <em>client's</em> app logic and validation
                function should prevent invalid documents from being created locally. The
                server-side sync function validation should be seen as a fail-safe and a guard
                against malicious access.</p><div class="note caution"><span class="tag">Caution:</span>It's very important to understand that channels govern whether
                a user can read a document, but <em>not</em> whether they can write to
                it! There are legitimate use cases for being able to create documents that you
                can't read afterwards (such as drop-boxes) so the Sync Gateway doesn't prevent
                this. <strong>By default, any user can create, update or delete any
                document</strong>; it's up to your sync function to check that the user
                submitting the revision is authorized to make the change.</div><p>In validating a document, you'll often need to compare the new revision
                to the old one, to check for illegal changes in state. For example, some properties
                may be immutable after the document is created, or may be changeable only by
                certain users, or may only be allowed to change in certain ways. That's why the
                current document contents are given to the sync function, as the
                <code>oldDoc</code> parameter.</p><div class="note caution"><span class="tag">Caution:</span>All properties of the <code>doc</code> parameter should be
                considered <em>untrusted</em>, since this is after all the object that
                you're validating. This may sound obvious, but it can be easy to make mistakes,
                like calling <code>requireUser(doc.owners)</code> instead of
                <code>requireUser(oldDoc.owners)</code>. When using one document property to
                validate another, look up that property in <code>oldDoc</code>, not
                <code>doc</code>!</div><p>Validation checks often need to treat deletions specially, because a
                deletion is just a revision with a <code>"_deleted":true</code> property and
                usually nothing else. Many types of validations won't work on a deletion because of
                the missing properties — for example, a check for a required property, or a check
                that a property value doesn't change. You'll need to skip such checks if
                <code>doc._deleted</code> is true.</p><p>There's a complete example sync function <a href="../../../../../develop/guides/sync-gateway/sync-function-api-guide/validation/index.html#example">at the end
                of this article</a> that demonstrates how to do several types of validation and
                authorization.</p><h2 id="throw"> throw ()</h2><hr></hr>
                        <p>At the most basic level, the sync function can prevent a
                        document from persisting or syncing to any other users by calling
                        <code>throw()</code> with an error object containing a
                        <code>forbidden:</code> property. You enforce the validity of
                        document structure by checking the necessary constraints and throwing an
                        exception if they're not met.</p>
                        <p>Here is an example sync function
                        that disallows all writes to the database it is in.</p>
<pre><code>function (doc) {
   throw ({forbidden : "read only!"})
}
</code></pre>
                        <p>The document update will be rejected with an <a href="http://en.wikipedia.org/wiki/HTTP_403">HTTP 403 "Forbidden" error
                        code</a>, with the value of the <code>forbidden:</code> property being
                        the HTTP status message. This is the preferred way to reject an
                        update.</p> <p>Any other exception (including implicit ones
                        thrown by the JavaScript runtime, like array bounds exceptions) will also
                        prevent the document update, but will cause the gateway to return an <a href="http://en.wikipedia.org/wiki/HTTP_500">HTTP
                        500 "Internal Error"</a> status.</p>
                    <h2 id="require-user">requireUser (username)</h2><hr></hr>
                        <p>The <code>requireUser()</code> function authorizes a document
                        update by rejecting it unless it's made by a
                        specific user or users, as shown in the following example:</p>
<pre><code>// throw an error if username is not "snej"
requireUser("snej");
                            
// throw if username is not in the list
requireUser(["snej", "jchris", "tleyden"]);
</code></pre>
                        <p>The function signals rejection by throwing an exception, so the
                        rest of the sync function will not be run.</p>
                    <h2 id="require-role">requireRole (rolename)</h2><hr></hr>
                        <p>The <code>requireRole()</code> function authorizes a document
                        update by rejecting it unless the user making it
                        has a specific role or roles, as shown in the following example:</p>
<pre><code>// throw an error unless the user has the "admin" role:
requireRole("admin");
                            
// throw an error unless the user has one or more of those roles:
requireRole(["admin", "old-timer"]);                          
</code></pre>
                        <p>The argument may be a single role name, or an array of role names. In the latter case, the user making the change must have one or more of the given roles.</p>
                        <p>The function signals rejection by throwing an exception, so the
                        rest of the sync function will not be run.</p>
                    <h2 id="require-access">requireAccess (channels)</h2><hr></hr>
                        <p> The <code>requireAccess()</code> function authorizes a document
                        update by rejecting it unless the user making it
                        has access to at least one of the given channels, as shown in the following
                        example: </p>
                        <pre><code>// throw an exception unless the user has access to read the "events" channel:
requireAccess("events");
                            
// throw an exception unless the user can read one of the channels in the
// previous revision's "channels" property:
if (oldDoc) {
    requireAccess(oldDoc.channels);
}
</code></pre>
                        <p>The function signals rejection by throwing an exception, so the
                        rest of the sync function will not be run.</p>
                    <h2 id="example">Example</h2><hr></hr>
                        <p>Here's an example of a complete, useful sync function that
                        properly validates and authorizes both new and updated documents. The
                        requirements are:</p>
                        <ul><li>Only users with the role <code>editor</code> may create or
                            delete documents.</li><li>Every document has an immutable <code>creator</code>
                            property containing the name of the user who created it.</li><li>Only users named in the document's (required, non-empty)
                            <code>writers</code> property may make changes to a document, including
                            deleting it.</li><li>Every document must also have a <code>title</code> and a
                            <code>channels</code> property.</li></ul>
                        <pre><code>function (doc, oldDoc) {
    if (doc._deleted) {
        // Only editors with write access can delete documents:
        requireRole("role:editor");
        requireUser(oldDoc.writers);
        // Skip other validation because a deletion has no other properties:
        return;
    }
    // Required properties:
    if (!doc.title || !doc.creator || !doc.channels || !doc.writers) {
        throw(forbidden: "Missing required properties");
    } else if (doc.writers.length == 0) {
        throw(forbidden: "No writers");
    }
    if (oldDoc == null) {
        // Only editors can create documents:
        requireRole("role:editor");
        // The 'creator' property must match the user creating the document:
        requireUser(doc.creator)
    } else {
        // Only users in the existing doc's writers list can change a document:
        requireUser(oldDoc.writers);
        // The "creator" property is immutable:
        if (doc.creator != oldDoc.creator) {
            throw(forbidden: "Can't change creator");
        }
    }
    // Finally, assign the document to the channels in the list:
    channel(doc.channels);
}
</code></pre>
                    </article><div class="page-footer"><span>Copyright © 2014 Couchbase Inc.  All rights reserved.</span><a href="http://www.couchbase.com/terms-of-service">Terms of Use</a><a href="http://www.couchbase.com/privacy">Privacy Policy</a></div></div></body></html>